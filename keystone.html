<!DOCTYPE html>
<html>
	<head>
		<title>Keystone</title>
		<script src="node_modules/peach.js/dist/peach.js"></script>
	</head>
	<body onload="keystone()">
		<canvas id="fzero-canvas" width="1024" height="2046">
		</canvas>
	</body>
	<script type="text/javascript">
		function keystoneAndDisplayImage(ctx, img, x, y, pixelWidth, scalingFactor) {
			var h = img.height,
				 w = img.width,

			 // The number of slices to draw.
			 numSlices = Math.abs(pixelWidth),

			 // The width of each source slice.
			 sliceWidth = w / numSlices,

			 // Whether to draw the slices in reverse order or not.
			 polarity = (pixelWidth > 0) ? 1 : -1,

			 // How much should we scale the width of the slice 
			 // before drawing?
			 widthScale = Math.abs(pixelWidth) / w,

			 // How much should we scale the height of the slice 
			 // before drawing? 
			 heightScale = (1 - scalingFactor) / numSlices;

		for(var n = 0; n < numSlices; n++) {

			// Source: where to take the slice from.
			var sx = sliceWidth * n,
				 sy = 0,
				 sWidth = sliceWidth,
				 sHeight = h;

			// Destination: where to draw the slice to 
			// (the transformation happens here).
			var dx = x + (sliceWidth * n * widthScale * polarity),
				 dy = y + ((h * heightScale * n) / 2),
				 dWidth = sliceWidth * widthScale,
				 dHeight = h * (1 - (heightScale * n));

			ctx.drawImage(img, sx, sy, sWidth, sHeight, 
					dx, dy, dWidth, dHeight);
			}
		}
		function keystone() {
			var ctx = document.getElementById('fzero-canvas').getContext('2d');

			var image = new Image();
			image.onload = function() {
				ctx.rotate(-Math.PI / 2);
				ctx.translate(-800, 0);
				keystoneAndDisplayImage(ctx, image, 0, 0, 500, 0.02);
			}
			image.src = '/images/map.png';
		}
	</script>
</html>
